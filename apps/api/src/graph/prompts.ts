import { db } from '../db/index.js';
import { prompts } from '../db/schema.js';
import { eq, and, desc } from 'drizzle-orm';

const DEFAULT_PROMPTS: Record<string, string> = {
  research: `Ты — исследовательский ассистент для технологического блога. Проведи глубокое исследование указанной темы.

Тема: {topic}
URL для анализа: {inputUrl}
Ключевые слова: {keywords}

Задачи:
1. Собери ключевые факты, цифры и актуальные данные по теме
2. Определи основные тенденции и экспертные мнения
3. Найди технические детали, спецификации и сравнительные характеристики
4. Выяви потенциальные проблемы и их решения
5. Подбери примеры применения и практические кейсы

Выведи структурированный отчёт на русском языке с подзаголовками для каждого раздела исследования. Используй конкретные цифры и факты, избегай общих фраз.`,

  outline: `Создай детальный план статьи для технологического блога на русском языке.

Тема: {topic}

Результаты исследования:
{research}

Контекст стиля (из эталонных статей):
{ragContext}

Требования к плану:
1. Заголовок H1 — цепляющий, информативный, содержит ключевые слова
2. 4–6 секций H2, каждая с кратким описанием содержания (2-3 предложения)
3. Для каждой секции укажи ключевые тезисы и данные из исследования
4. Обозначь места для вставки иллюстраций (после какой секции)
5. Предусмотри введение и заключение

Формат вывода — markdown, где каждая секция обозначена через ## заголовок, после которого идёт описание.`,

  write_section: `Напиши секцию статьи для технологического блога на русском языке.

Заголовок секции: {sectionTitle}
Описание секции: {sectionDescription}
Полный план статьи: {outline}
Данные исследования: {research}
Контекст стиля (из эталонных статей): {ragContext}
Ссылки компании для органичной интеграции: {companyLinks}

Требования:
- Профессиональный, но доступный тон — как для опытного IT-специалиста
- Конкретика: цифры, характеристики, сравнения, примеры
- Активная форма глаголов, без канцелярита
- Логичные переходы между абзацами
- Технические термины с пояснениями, где это нужно
- Если релевантно, органично вставь ссылки компании в текст
- Объём: 300–500 слов для секции

Выведи только текст секции в формате markdown (без повторения заголовка H2).`,

  edit_polish: `Отредактируй и доработай черновик статьи для технологического блога на русском языке.

Черновик:
{draft}

Контекст стиля (из эталонных статей):
{ragContext}

Целевые ключевые слова для SEO: {keywords}

Задачи редактуры:
1. Проверь логику изложения и связность между секциями
2. Оптимизируй для SEO: ключевые слова в заголовках и первых абзацах
3. Выровняй тон: профессиональный, живой, без канцелярита — как в эталонных статьях
4. Проверь техническую точность формулировок
5. Добавь плавные переходы между секциями
6. Убери повторы, длинноты, общие фразы
7. Убедись, что введение цепляет, а заключение содержит конкретный вывод

ВАЖНО: Выведи ТОЛЬКО текст статьи в формате markdown. БЕЗ вступительных фраз, БЕЗ комментариев от себя, БЕЗ строк "Meta Description", БЕЗ пояснений что ты изменил. Начни сразу с заголовка H1 статьи (# Заголовок). Сохрани всю структуру H1/H2.`,

  image_prompt: `Сгенерируй промпты для создания иллюстраций к технологической статье.

Заголовок статьи: {title}
Секции: {sections}

Создай {count} промптов для генерации изображений, каждый на отдельной строке.
Каждый промпт должен описывать чистую, профессиональную иллюстрацию в tech-стиле.
Промпты пиши на английском языке (для генератора изображений).
Формат: минималистичный flat design, яркие цвета, без текста на изображении.`,
};

export const getPromptTemplate = async (stage: string): Promise<string> => {
  try {
    const [prompt] = await db.select()
      .from(prompts)
      .where(and(eq(prompts.stage, stage), eq(prompts.isActive, true)))
      .orderBy(desc(prompts.version))
      .limit(1);

    if (prompt) return prompt.template;
  } catch {
    // DB not available, use defaults
  }
  return DEFAULT_PROMPTS[stage] || '';
};
